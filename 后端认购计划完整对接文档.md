# åç«¯è®¤è´­è®¡åˆ’å®Œæ•´å¯¹æ¥æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

è®¤è´­è®¡åˆ’ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„æŠ•èµ„ç†è´¢æ¨¡å—ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
- **è®¤è´­è®¡åˆ’ç®¡ç†**: åˆ›å»ºå’Œç®¡ç†ä¸åŒæ¡£ä½çš„æŠ•èµ„è®¡åˆ’
- **è®¢å•ç®¡ç†**: ç”¨æˆ·è´­ä¹°è®¡åˆ’ã€è®¢å•çŠ¶æ€è·Ÿè¸ª
- **æ”¶ç›Šè®¡ç®—**: é™æ€æ”¶ç›Šå’ŒAIä»£å¸æ”¶ç›Šè®¡ç®—
- **é’±åŒ…ç®¡ç†**: USDTå’ŒAIä»£å¸ä½™é¢ç®¡ç†
- **å¥–åŠ±ç³»ç»Ÿ**: é‚€è¯·å¥–åŠ±ã€æŠ½å¥–æœºä¼šã€ä»£å¸å¥–åŠ±

## ğŸ—ï¸ æ•°æ®æ¨¡å‹

### 1. è®¤è´­è®¡åˆ’ (dinggou-jihua)

**Schemaå®šä¹‰**:
```typescript
{
  jihuaCode   : { type: 'string',  required: true, unique: true },   // è®¡åˆ’ä»£ç 
  benjinUSDT  : { type: 'string', required: true, default: '0' },    // æœ¬é‡‘USDT
  zhouQiTian  : { type: 'integer', required: true, default: 15 },    // å‘¨æœŸå¤©æ•°
  jingtaiBili : { type: 'string', required: true, default: '0' },    // é™æ€æ¯”ä¾‹%
  aiBili      : { type: 'string', required: true, default: '0' },    // AIæ¯”ä¾‹%
  choujiangCi : { type: 'integer',  default: 3 },                    // æŠ½å¥–æ¬¡æ•°
  kaiqi       : { type: 'boolean',  default: true },                 // æ˜¯å¦å¼€å¯
  dingdanList : { type: 'relation', relation: 'oneToMany',           // å…³è”è®¢å•
                  target: 'api::dinggou-dingdan.dinggou-dingdan', mappedBy: 'jihua' },
}
```

**ç¤ºä¾‹æ•°æ®**:
```json
{
  "id": 1,
  "jihuaCode": "PLAN500",
  "benjinUSDT": "500",
  "zhouQiTian": 15,
  "jingtaiBili": "6",
  "aiBili": "3",
  "choujiangCi": 3,
  "kaiqi": true
}
```

### 2. è®¤è´­è®¢å• (dinggou-dingdan)

**Schemaå®šä¹‰**:
```typescript
{
  benjinUSDT    : { type: 'string', required: true },                // æœ¬é‡‘USDT
  zhuangtai     : { type: 'enumeration', enum: ['active','redeemable','finished'], default: 'active' },
  kaishiShiJian : { type: 'datetime', required: true },              // å¼€å§‹æ—¶é—´
  jieshuShiJian : { type: 'datetime', required: true },              // ç»“æŸæ—¶é—´
  jingtaiShouyi : { type: 'string', default: '0' },                  // é™æ€æ”¶ç›Š
  aiShuliang    : { type: 'string', default: '0' },                  // AIæ•°é‡
  yonghu        : { type: 'relation', relation: 'manyToOne',         // å…³è”ç”¨æˆ·
                    target: 'plugin::users-permissions.user', inversedBy: 'dinggouOrders' },
  jihua         : { type: 'relation', relation: 'manyToOne',         // å…³è”è®¡åˆ’
                    target: 'api::dinggou-jihua.dinggou-jihua', inversedBy: 'dingdanList' },
  jiangli       : { type: 'relation', relation: 'oneToOne',          // å…³è”å¥–åŠ±
                    target: 'api::yaoqing-jiangli.yaoqing-jiangli' },
}
```

**è®¢å•çŠ¶æ€è¯´æ˜**:
- `active`: è¿›è¡Œä¸­ï¼Œæœªåˆ°æœŸ
- `redeemable`: å¯èµå›ï¼Œå·²åˆ°æœŸ
- `finished`: å·²å®Œæˆï¼Œå·²èµå›

### 3. é’±åŒ…ä½™é¢ (qianbao-yue)

**Schemaå®šä¹‰**:
```typescript
{
  usdtYue : { type: 'string', default: '0' },                        // USDTä½™é¢
  aiYue   : { type: 'string', default: '0' },                        // AIä½™é¢
  aiTokenBalances: { 
    type: 'json', 
    default: '{}',
    description: 'AIä»£å¸ä½™é¢JSONæ ¼å¼ {tokenId: balance}'
  },
  yonghu  : { type: 'relation', relation: 'oneToOne',                // å…³è”ç”¨æˆ·
              target: 'plugin::users-permissions.user', inversedBy: 'qianbao' },
}
```

### 4. AIä»£å¸ (ai-token)

**Schemaå®šä¹‰**:
```typescript
{
  name: { type: 'string', required: true, unique: true, maxLength: 100 },
  symbol: { type: 'string', required: true, unique: true, maxLength: 20 },
  contractAddress: { type: 'string', maxLength: 100 },               // åˆçº¦åœ°å€
  priceSource: { 
    type: 'enumeration',
    enum: ['coingecko', 'binance', 'dexscreener'],
    required: true
  },
  priceApiId: { type: 'string', maxLength: 100 },                    // APIä»£å¸ID
  weight: { type: 'integer', default: 20, min: 1, max: 100 },        // æƒé‡
  isActive: { type: 'boolean', default: true },                      // æ˜¯å¦å¯ç”¨
  logoUrl: { type: 'string', maxLength: 255 },                       // å›¾æ ‡URL
  description: { type: 'text' },                                     // æè¿°
}
```

## ğŸ”Œ APIæ¥å£

### 1. è®¤è´­è®¡åˆ’æ¥å£

#### 1.1 è·å–è®¤è´­è®¡åˆ’åˆ—è¡¨
```http
GET /api/dinggou-jihuas?filters[kaiqi]=true
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "data": [
    {
      "id": 1,
      "attributes": {
        "jihuaCode": "PLAN500",
        "benjinUSDT": "500",
        "zhouQiTian": 15,
        "jingtaiBili": "6",
        "aiBili": "3",
        "choujiangCi": 3,
        "kaiqi": true
      }
    }
  ],
  "meta": {
    "pagination": {
      "page": 1,
      "pageSize": 25,
      "pageCount": 1,
      "total": 1
    }
  }
}
```

#### 1.2 è·å–å•ä¸ªè®¤è´­è®¡åˆ’
```http
GET /api/dinggou-jihuas/:id
```

#### 1.3 åˆ›å»ºè®¤è´­è®¡åˆ’ (ç®¡ç†å‘˜)
```http
POST /api/dinggou-jihuas
Content-Type: application/json

{
  "data": {
    "jihuaCode": "PLAN500",
    "benjinUSDT": "500",
    "zhouQiTian": 15,
    "jingtaiBili": "6",
    "aiBili": "3",
    "choujiangCi": 3,
    "kaiqi": true
  }
}
```

### 2. è®¤è´­è®¢å•æ¥å£

#### 2.1 åˆ›å»ºè®¤è´­è®¢å•
```http
POST /api/dinggou-dingdans
Content-Type: application/json
Authorization: Bearer <user_token>

{
  "data": {
    "jihuaId": 1
  }
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "benjinUSDT": "500",
    "zhuangtai": "active",
    "kaishiShiJian": "2024-01-01T00:00:00.000Z",
    "jieshuShiJian": "2024-01-16T00:00:00.000Z",
    "yonghu": 1,
    "jihua": 1
  }
}
```

#### 2.2 è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
```http
GET /api/dinggou-dingdans?filters[yonghu][$eq]=1&populate=jihua
```

#### 2.3 èµå›è®¢å•
```http
POST /api/dinggou-dingdans/:id/redeem
Content-Type: application/json
Authorization: Bearer <user_token>

{
  "force": false,
  "testMode": false
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "orderId": 1,
    "benjinUSDT": "500",
    "staticUSDT": "30.00",
    "aiQty": "15.00000000",
    "selectedToken": {
      "id": 1,
      "name": "AI Token",
      "symbol": "AIT",
      "amount": "15.00000000",
      "usdtValue": "15.00",
      "price": "1.00000000"
    },
    "isExpired": true,
    "startTime": "2024-01-01T00:00:00.000Z",
    "endTime": "2024-01-16T00:00:00.000Z",
    "currentTime": "2024-01-16T12:00:00.000Z"
  }
}
```

### 3. é’±åŒ…ä½™é¢æ¥å£

#### 3.1 è·å–ç”¨æˆ·é’±åŒ…ä½™é¢
```http
GET /api/qianbao-yues?filters[yonghu][$eq]=1
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "data": [
    {
      "id": 1,
      "attributes": {
        "usdtYue": "1000.00",
        "aiYue": "50.00000000",
        "aiTokenBalances": {
          "1": "10.00000000",
          "2": "5.00000000"
        }
      }
    }
  ]
}
```

### 4. AIä»£å¸æ¥å£

#### 4.1 è·å–AIä»£å¸åˆ—è¡¨
```http
GET /api/ai-tokens?filters[isActive][$eq]=true
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "data": [
    {
      "id": 1,
      "attributes": {
        "name": "AI Token",
        "symbol": "AIT",
        "contractAddress": "0x...",
        "priceSource": "coingecko",
        "priceApiId": "ai-token",
        "weight": 20,
        "isActive": true,
        "logoUrl": "https://...",
        "description": "AIä»£å¸æè¿°"
      }
    }
  ]
}
```

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### 1. è®¤è´­æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©è®¡åˆ’] --> B[ç‚¹å‡»è®¤è´­]
    B --> C[éªŒè¯ç”¨æˆ·ä½™é¢]
    C --> D[æ‰£é™¤USDTä½™é¢]
    D --> E[åˆ›å»ºè®¢å•]
    E --> F[è®¾ç½®åˆ°æœŸæ—¶é—´]
    F --> G[è®¢å•çŠ¶æ€: active]
```

### 2. èµå›æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·ç‚¹å‡»èµå›] --> B[æ£€æŸ¥è®¢å•çŠ¶æ€]
    B --> C{æ˜¯å¦åˆ°æœŸ?}
    C -->|æ˜¯| D[è®¡ç®—æ”¶ç›Š]
    C -->|å¦| E[è¿”å›æœªåˆ°æœŸé”™è¯¯]
    D --> F[æ›´æ–°é’±åŒ…ä½™é¢]
    F --> G[åˆ›å»ºé‚€è¯·å¥–åŠ±]
    G --> H[åˆ›å»ºæŠ½å¥–æœºä¼š]
    H --> I[éšæœºé€‰æ‹©AIä»£å¸]
    I --> J[æ›´æ–°è®¢å•çŠ¶æ€: finished]
```

### 3. æ”¶ç›Šè®¡ç®—è§„åˆ™

#### 3.1 é™æ€æ”¶ç›Šè®¡ç®—
```
é™æ€æ”¶ç›Š = æœ¬é‡‘ Ã— é™æ€æ¯”ä¾‹% Ã— å®é™…å¤©æ•° / æ€»å¤©æ•°
```

#### 3.2 AIä»£å¸æ”¶ç›Šè®¡ç®—
```
AIä»£å¸æ•°é‡ = æœ¬é‡‘ Ã— AIæ¯”ä¾‹% / AIä»£å¸ä»·æ ¼
```

#### 3.3 æœªåˆ°æœŸèµå›æ¯”ä¾‹è®¡ç®—
```
å®é™…æ¯”ä¾‹ = å·²è¿‡æ—¶é—´ / æ€»æ—¶é—´
å®é™…æ”¶ç›Š = é¢„æœŸæ”¶ç›Š Ã— å®é™…æ¯”ä¾‹
```

## ğŸ¯ å‰ç«¯å¯¹æ¥è¦ç‚¹

### 1. é¡µé¢ç»“æ„å»ºè®®

#### 1.1 è®¤è´­è®¡åˆ’åˆ—è¡¨é¡µ
- æ˜¾ç¤ºæ‰€æœ‰å¼€å¯çš„è®¡åˆ’
- æ¯ä¸ªè®¡åˆ’æ˜¾ç¤ºï¼šæœ¬é‡‘ã€å‘¨æœŸã€æ”¶ç›Šç‡ã€æŠ½å¥–æ¬¡æ•°
- ç‚¹å‡»è¿›å…¥è®¤è´­ç¡®è®¤é¡µ

#### 1.2 è®¤è´­ç¡®è®¤é¡µ
- æ˜¾ç¤ºè®¡åˆ’è¯¦æƒ…
- æ˜¾ç¤ºç”¨æˆ·å½“å‰ä½™é¢
- ç¡®è®¤è®¤è´­æŒ‰é’®

#### 1.3 æˆ‘çš„è®¢å•é¡µ
- æ˜¾ç¤ºç”¨æˆ·æ‰€æœ‰è®¢å•
- è®¢å•çŠ¶æ€ï¼šè¿›è¡Œä¸­/å¯èµå›/å·²å®Œæˆ
- æ˜¾ç¤ºå‰©ä½™æ—¶é—´å’Œæ”¶ç›Šé¢„ä¼°

#### 1.4 è®¢å•è¯¦æƒ…é¡µ
- æ˜¾ç¤ºè®¢å•å®Œæ•´ä¿¡æ¯
- èµå›æŒ‰é’®ï¼ˆä»…å¯èµå›çŠ¶æ€ï¼‰
- æ”¶ç›Šæ˜ç»†

### 2. å…³é”®APIè°ƒç”¨

#### 2.1 è·å–è®¡åˆ’åˆ—è¡¨
```dart
final response = await _httpClient.dio.get('/api/dinggou-jihuas?filters[kaiqi]=true');
```

#### 2.2 åˆ›å»ºè®¢å•
```dart
final response = await _httpClient.dio.post('/api/dinggou-dingdans', data: {
  'data': {
    'jihuaId': planId
  }
});
```

#### 2.3 è·å–ç”¨æˆ·è®¢å•
```dart
final response = await _httpClient.dio.get('/api/dinggou-dingdans?filters[yonghu][\$eq]=$userId&populate=jihua');
```

#### 2.4 èµå›è®¢å•
```dart
final response = await _httpClient.dio.post('/api/dinggou-dingdans/$orderId/redeem', data: {
  'force': false
});
```

### 3. çŠ¶æ€ç®¡ç†

#### 3.1 è®¢å•çŠ¶æ€æ˜ å°„
```dart
enum OrderStatus {
  active,      // è¿›è¡Œä¸­
  redeemable,  // å¯èµå›
  finished     // å·²å®Œæˆ
}
```

#### 3.2 æ—¶é—´è®¡ç®—
```dart
// è®¡ç®—å‰©ä½™æ—¶é—´
DateTime endTime = DateTime.parse(order['jieshuShiJian']);
DateTime now = DateTime.now();
Duration remaining = endTime.difference(now);
```

### 4. é”™è¯¯å¤„ç†

#### 4.1 å¸¸è§é”™è¯¯ç 
- `400`: ä½™é¢ä¸è¶³ã€è®¢å•æœªåˆ°æœŸã€è®¡åˆ’ä¸å­˜åœ¨
- `401`: ç”¨æˆ·æœªç™»å½•
- `403`: æ— æƒæ“ä½œ
- `404`: è®¢å•ä¸å­˜åœ¨

#### 4.2 é”™è¯¯æ¶ˆæ¯
- "ä½™é¢ä¸è¶³"
- "è®¢å•å°šæœªåˆ°æœŸï¼Œè¿˜éœ€ç­‰å¾… X å¤©"
- "è¯¥æŠ•èµ„è®¡åˆ’å·²å…³é—­"
- "è®¢å•çŠ¶æ€ä¸å…è®¸èµå›"

## ğŸ§ª æµ‹è¯•æ•°æ®

### 1. æµ‹è¯•è®¡åˆ’æ•°æ®
```json
[
  {
    "jihuaCode": "PLAN500",
    "benjinUSDT": "500",
    "zhouQiTian": 15,
    "jingtaiBili": "6",
    "aiBili": "3",
    "choujiangCi": 3,
    "kaiqi": true
  },
  {
    "jihuaCode": "PLAN1000",
    "benjinUSDT": "1000",
    "zhouQiTian": 20,
    "jingtaiBili": "7",
    "aiBili": "4",
    "choujiangCi": 5,
    "kaiqi": true
  },
  {
    "jihuaCode": "PLAN3000",
    "benjinUSDT": "3000",
    "zhouQiTian": 25,
    "jingtaiBili": "8",
    "aiBili": "5",
    "choujiangCi": 8,
    "kaiqi": true
  },
  {
    "jihuaCode": "PLAN5000",
    "benjinUSDT": "5000",
    "zhouQiTian": 30,
    "jingtaiBili": "9",
    "aiBili": "6",
    "choujiangCi": 12,
    "kaiqi": true
  }
]
```

### 2. æµ‹è¯•å‘½ä»¤
```bash
# è·å–è®¡åˆ’åˆ—è¡¨
curl -X GET "http://118.107.4.158:1337/api/dinggou-jihuas?filters[kaiqi]=true"

# åˆ›å»ºè®¢å•
curl -X POST "http://118.107.4.158:1337/api/dinggou-dingdans" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"data":{"jihuaId":1}}'

# èµå›è®¢å•
curl -X POST "http://118.107.4.158:1337/api/dinggou-dingdans/1/redeem" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"force":false}'
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è®¤è¯è¦æ±‚**: æ‰€æœ‰è®¢å•ç›¸å…³æ¥å£éƒ½éœ€è¦ç”¨æˆ·ç™»å½•
2. **ä½™é¢æ£€æŸ¥**: åˆ›å»ºè®¢å•å‰ä¼šè‡ªåŠ¨æ£€æŸ¥ç”¨æˆ·ä½™é¢
3. **æ—¶é—´è®¡ç®—**: èµå›æ—¶ä¼šè‡ªåŠ¨è®¡ç®—å®é™…æ”¶ç›Š
4. **äº‹åŠ¡å¤„ç†**: æ‰€æœ‰èµ„é‡‘æ“ä½œéƒ½ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿ä¸€è‡´æ€§
5. **é”™è¯¯å¤„ç†**: è¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯å¸®åŠ©ç”¨æˆ·ç†è§£é—®é¢˜
6. **çŠ¶æ€ç®¡ç†**: è®¢å•çŠ¶æ€è‡ªåŠ¨æµè½¬ï¼Œæ— éœ€æ‰‹åŠ¨æ›´æ–°

---
*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*æ›´æ–°æ—¶é—´: 2024å¹´1æœˆ1æ—¥* 