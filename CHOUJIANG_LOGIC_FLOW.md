# 🎰 抽奖系统逻辑流程

## 🔄 完整业务流程图

```
用户投资 → 订单赎回 → 创建抽奖机会 → 用户抽奖 → 获得奖品 → 商城使用
    ↓           ↓           ↓           ↓         ↓         ↓
  投资订单    赎回成功    抽奖机会    抽奖执行    奖品记录    商城兑换
    ↓           ↓           ↓           ↓         ↓         ↓
  配置抽奖次数  自动触发    状态active   概率算法    状态zhongJiang  状态yiLingQu
```

## 📊 详细逻辑分解

### 1. 投资订单赎回逻辑
```
用户赎回订单
    ↓
检查订单状态和用户权限
    ↓
计算收益并更新钱包
    ↓
检查投资计划配置
    ↓
获取 choujiangCi 字段值
    ↓
如果 choujiangCi > 0
    ↓
创建抽奖机会记录
    ↓
设置 zongCiShu = choujiangCi
    ↓
设置 shengYuCiShu = choujiangCi
    ↓
设置 zhuangtai = 'active'
```

### 2. 抽奖机会验证逻辑
```
用户发起抽奖
    ↓
验证用户身份
    ↓
检查抽奖机会是否存在
    ↓
验证 shengYuCiShu > 0
    ↓
验证 zhuangtai = 'active'
    ↓
检查机会是否过期
    ↓
验证通过，继续抽奖
```

### 3. 奖品选择逻辑
```
获取可用奖品列表
    ↓
过滤条件：
- kaiQi = true
- kuCunShuLiang > 0
    ↓
按 paiXuShunXu 排序
    ↓
执行概率算法
    ↓
随机数生成 (0-100)
    ↓
累积概率计算
    ↓
选择对应奖品
    ↓
保底机制（选择概率最高的）
```

### 4. 库存管理逻辑
```
选中奖品后
    ↓
检查 kuCunShuLiang > 0
    ↓
更新 kuCunShuLiang = kuCunShuLiang - 1
    ↓
更新 yiFaChuShuLiang = yiFaChuShuLiang + 1
    ↓
更新抽奖机会 shengYuCiShu = shengYuCiShu - 1
    ↓
如果 shengYuCiShu = 0
    ↓
设置 zhuangtai = 'used'
```

### 5. 记录创建逻辑
```
抽奖成功后
    ↓
创建抽奖记录
    ↓
设置关联关系：
- yonghu = userId
- jiangpin = prizeId
- choujiangJihui = jihuiId
- dingdan = orderId
    ↓
设置冗余字段：
- jiangPinMing = prize.jiangpinMing
- jiangPinJiaZhi = prize.jiangpinJiaZhi
- jiangPinLeiXing = prize.jiangpinLeiXing
    ↓
设置状态字段：
- zhuangtai = 'zhongJiang'
- chouJiangShiJian = new Date()
```

### 6. 奖品领取逻辑
```
用户领取奖品
    ↓
验证抽奖记录存在
    ↓
检查记录属于当前用户
    ↓
验证 zhuangtai = 'zhongJiang'
    ↓
更新记录状态：
- zhuangtai = 'yiLingQu'
- lingQuShiJian = new Date()
- beiZhu = '奖品已领取，请到商城查看'
    ↓
与商城板块同步
```

## 🎯 关键业务规则

### 1. 抽奖机会规则
- **创建条件**: 订单赎回成功 + 投资计划配置 choujiangCi > 0
- **使用限制**: 一次性使用，剩余次数递减
- **状态变化**: active → used (当剩余次数为0)
- **过期机制**: 可配置过期时间

### 2. 奖品管理规则
- **库存控制**: kuCunShuLiang 和 yiFaChuShuLiang 实时更新
- **概率算法**: 基于 zhongJiangGaiLv 的累积概率
- **保底机制**: 确保每次抽奖都能获得奖品
- **类型分类**: SHANG_PIN/JIN_BI/YOU_HUI_QUAN

### 3. 数据一致性规则
- **事务处理**: 所有相关操作在同一事务中执行
- **状态同步**: 抽奖机会、奖品库存、抽奖记录状态同步更新
- **冗余字段**: 关键信息冗余存储，便于查询和显示
- **关联关系**: 完整的数据关联，支持复杂查询

### 4. 安全验证规则
- **用户权限**: 只能操作自己的抽奖机会和记录
- **状态验证**: 严格的状态检查，防止重复操作
- **库存验证**: 实时库存检查，防止超发
- **数据完整性**: 关联数据的一致性验证

## 🔗 集成点说明

### 1. 投资订单集成
- **触发时机**: 订单赎回成功时
- **集成方式**: 服务调用
- **数据传递**: 用户ID、订单ID、抽奖次数
- **异常处理**: 抽奖机会创建失败不影响订单赎回

### 2. 商城板块集成
- **数据关联**: 通过抽奖记录关联商城商品
- **状态同步**: 奖品领取状态影响商城可用性
- **接口调用**: 商城可查询用户奖品和使用奖品
- **业务逻辑**: 奖品在商城中的具体使用方式

## 🎲 概率算法详解

### 算法流程
```
1. 获取所有可用奖品
2. 生成随机数 (0-100)
3. 遍历奖品，累积概率
4. 当累积概率 >= 随机数时，选中该奖品
5. 如果没有选中，返回概率最高的奖品（保底）
```

### 概率计算示例
```
奖品A: 概率30%
奖品B: 概率20%
奖品C: 概率10%

随机数生成: 45

累积计算:
- 奖品A: 0-30 (不命中)
- 奖品B: 30-50 (命中，选中奖品B)
```

## 📋 测试验证点

### 1. 功能测试
- ✅ 订单赎回自动创建抽奖机会
- ✅ 抽奖机会验证和状态管理
- ✅ 概率算法正确性
- ✅ 库存管理准确性
- ✅ 记录创建完整性

### 2. 异常测试
- ✅ 无抽奖机会时的错误处理
- ✅ 奖品库存不足时的处理
- ✅ 重复抽奖的防护
- ✅ 无效数据的验证

### 3. 集成测试
- ✅ 与投资订单系统的集成
- ✅ 与商城板块的数据关联
- ✅ 事务处理的正确性
- ✅ 数据一致性验证

**逻辑流程清晰，各环节衔接紧密，可以开始测试验证！** 🎰 