# åç«¯ç™»å½•æ³¨å†Œç³»ç»Ÿå¯¹æ¥æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [API åŸºç¡€ä¿¡æ¯](#api-åŸºç¡€ä¿¡æ¯)
3. [æ³¨å†Œæ¥å£](#æ³¨å†Œæ¥å£)
4. [ç™»å½•æ¥å£](#ç™»å½•æ¥å£)
5. [ç”¨æˆ·æ•°æ®ç»“æ„](#ç”¨æˆ·æ•°æ®ç»“æ„)
6. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
7. [å‰ç«¯é›†æˆç¤ºä¾‹](#å‰ç«¯é›†æˆç¤ºä¾‹)
8. [æµ‹è¯•ç”¨ä¾‹](#æµ‹è¯•ç”¨ä¾‹)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»ŸåŸºäº Strapi æ¡†æ¶æ„å»ºï¼Œä½¿ç”¨ `users-permissions` æ’ä»¶æä¾›ç”¨æˆ·è®¤è¯åŠŸèƒ½ï¼Œå¹¶æ‰©å±•äº†é‚€è¯·ç æ³¨å†Œæœºåˆ¶ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… é‚€è¯·ç æ³¨å†Œç³»ç»Ÿ
- âœ… ç”¨æˆ·å/é‚®ç®±ç™»å½•
- âœ… JWT Token è®¤è¯
- âœ… è‡ªåŠ¨é’±åŒ…åˆ›å»º
- âœ… ç”¨æˆ·å…³ç³»ç®¡ç†ï¼ˆä¸Šä¸‹çº§ï¼‰
- âœ… è¾“å…¥éªŒè¯å’Œæ¸…ç†

---

## ğŸŒ API åŸºç¡€ä¿¡æ¯

### æœåŠ¡å™¨åœ°å€
```
ç”Ÿäº§ç¯å¢ƒ: https://api.zenithus.com
æµ‹è¯•ç¯å¢ƒ: http://118.107.4.158:1337
```

### åŸºç¡€è·¯å¾„
```
API å‰ç¼€: /api
è®¤è¯æ¥å£: /api/auth
```

### è¯·æ±‚å¤´
```http
Content-Type: application/json
Authorization: Bearer <jwt_token>  // éœ€è¦è®¤è¯çš„æ¥å£
```

---

## ğŸ“ æ³¨å†Œæ¥å£

### é‚€è¯·ç æ³¨å†Œ
**POST** `/api/auth/invite-register`

#### è¯·æ±‚å‚æ•°
```json
{
  "username": "string",     // ç”¨æˆ·å (3-20å­—ç¬¦)
  "email": "string",        // é‚®ç®±åœ°å€
  "password": "string",     // å¯†ç  (æœ€å°‘6å­—ç¬¦)
  "inviteCode": "string"    // é‚€è¯·ç  (9ä½å¤§å†™å­—æ¯æ•°å­—ç»„åˆ)
}
```

#### æˆåŠŸå“åº” (200)
```json
{
  "success": true,
  "userId": 123,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "inviteCode": "ABC123DEF"
}
```

#### å¤±è´¥å“åº” (400)
```json
{
  "error": {
    "message": "é”™è¯¯ä¿¡æ¯"
  }
}
```

#### éªŒè¯è§„åˆ™
| å­—æ®µ | è§„åˆ™ | é”™è¯¯ä¿¡æ¯ |
|------|------|----------|
| username | 3-20å­—ç¬¦ï¼Œå”¯ä¸€ | "ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦ï¼Œæœ€å¤š20ä¸ªå­—ç¬¦" |
| email | æœ‰æ•ˆé‚®ç®±æ ¼å¼ï¼Œå”¯ä¸€ | "é‚®ç®±æ ¼å¼æ— æ•ˆ" |
| password | æœ€å°‘6å­—ç¬¦ | "å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦" |
| inviteCode | 8-10ä½å¤§å†™å­—æ¯æ•°å­— | "é‚€è¯·ç æ ¼å¼æ— æ•ˆ" |

#### ä¸šåŠ¡é€»è¾‘
1. **è¾“å…¥éªŒè¯**: æ¸…ç†å’ŒéªŒè¯æ‰€æœ‰è¾“å…¥å­—æ®µ
2. **é‡å¤æ£€æŸ¥**: æ£€æŸ¥ç”¨æˆ·åå’Œé‚®ç®±æ˜¯å¦å·²å­˜åœ¨
3. **é‚€è¯·ç éªŒè¯**: éªŒè¯é‚€è¯·ç æ˜¯å¦å­˜åœ¨
4. **ç”Ÿæˆé‚€è¯·ç **: ä¸ºæ–°ç”¨æˆ·ç”Ÿæˆå”¯ä¸€çš„9ä½é‚€è¯·ç 
5. **åˆ›å»ºç”¨æˆ·**: ä½¿ç”¨ Strapi ç”¨æˆ·æœåŠ¡åˆ›å»ºç”¨æˆ·
6. **åˆ›å»ºé’±åŒ…**: è‡ªåŠ¨ä¸ºç”¨æˆ·åˆ›å»ºé’±åŒ…ä½™é¢è®°å½•
7. **å»ºç«‹å…³ç³»**: è®¾ç½®ç”¨æˆ·ä¸Šä¸‹çº§å…³ç³»

---

## ğŸ” ç™»å½•æ¥å£

### ç”¨æˆ·ç™»å½•
**POST** `/api/auth/local`

#### è¯·æ±‚å‚æ•°
```json
{
  "identifier": "string",  // ç”¨æˆ·åæˆ–é‚®ç®±
  "password": "string"     // å¯†ç 
}
```

#### æˆåŠŸå“åº” (200)
```json
{
  "jwt": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 123,
    "username": "testuser",
    "email": "test@example.com",
    "confirmed": true,
    "blocked": false,
    "role": {
      "id": 1,
      "name": "Authenticated",
      "description": "Default role given to authenticated user.",
      "type": "authenticated"
    },
    "yaoqingMa": "ABC123DEF",
    "shangji": {
      "id": 100,
      "username": "referrer"
    },
    "qianbao": {
      "id": 456,
      "yue": 0
    },
    "created_at": "2024-01-01T00:00:00.000Z",
    "updated_at": "2024-01-01T00:00:00.000Z"
  }
}
```

#### å¤±è´¥å“åº” (400)
```json
{
  "error": {
    "message": "Invalid identifier or password."
  }
}
```

---

## ğŸ‘¤ ç”¨æˆ·æ•°æ®ç»“æ„

### ç”¨æˆ·æ¨¡å‹ (User)
```typescript
interface User {
  id: number;
  username: string;           // ç”¨æˆ·å
  email: string;             // é‚®ç®±
  confirmed: boolean;        // æ˜¯å¦å·²ç¡®è®¤
  blocked: boolean;          // æ˜¯å¦è¢«ç¦ç”¨
  role: Role;               // ç”¨æˆ·è§’è‰²
  yaoqingMa: string;        // é‚€è¯·ç  (9ä½)
  shangji?: User;           // ä¸Šçº§ç”¨æˆ·
  xiaji?: User[];           // ä¸‹çº§ç”¨æˆ·åˆ—è¡¨
  qianbao?: Wallet;         // é’±åŒ…ä¿¡æ¯
  created_at: string;
  updated_at: string;
}
```

### é’±åŒ…æ¨¡å‹ (Wallet)
```typescript
interface Wallet {
  id: number;
  yue: number;              // ä½™é¢
  yonghu: number;           // ç”¨æˆ·ID
}
```

### è§’è‰²æ¨¡å‹ (Role)
```typescript
interface Role {
  id: number;
  name: string;             // è§’è‰²åç§°
  description: string;      // è§’è‰²æè¿°
  type: string;            // è§’è‰²ç±»å‹
}
```

---

## âŒ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯ç 
| çŠ¶æ€ç  | é”™è¯¯ç±»å‹ | è¯´æ˜ |
|--------|----------|------|
| 400 | Bad Request | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | Unauthorized | æœªè®¤è¯æˆ–Tokenæ— æ•ˆ |
| 403 | Forbidden | æƒé™ä¸è¶³ |
| 404 | Not Found | èµ„æºä¸å­˜åœ¨ |
| 500 | Internal Server Error | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

### é”™è¯¯å“åº”æ ¼å¼
```json
{
  "error": {
    "message": "å…·ä½“é”™è¯¯ä¿¡æ¯",
    "details": {
      "field": "å­—æ®µå",
      "value": "é”™è¯¯å€¼"
    }
  }
}
```

### å¸¸è§é”™è¯¯ä¿¡æ¯
- `"ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦ï¼Œæœ€å¤š20ä¸ªå­—ç¬¦"`
- `"é‚®ç®±æ ¼å¼æ— æ•ˆ"`
- `"å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦"`
- `"é‚€è¯·ç æ ¼å¼æ— æ•ˆ"`
- `"ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨"`
- `"é‚€è¯·ç æ— æ•ˆ"`
- `"ç”Ÿæˆé‚€è¯·ç å¤±è´¥ï¼Œè¯·é‡è¯•"`
- `"Invalid identifier or password."`

---

## ğŸ’» å‰ç«¯é›†æˆç¤ºä¾‹

### Flutter/Dart ç¤ºä¾‹

#### HTTP å®¢æˆ·ç«¯é…ç½®
```dart
import 'package:dio/dio.dart';
import 'package:shared_preferences/shared_preferences.dart';

class HttpClient {
  static const String baseUrl = 'https://api.zenithus.com';
  late Dio _dio;

  void init() {
    _dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      connectTimeout: const Duration(seconds: 10),
      receiveTimeout: const Duration(seconds: 10),
      headers: {'Content-Type': 'application/json'},
    ));

    // è¯·æ±‚æ‹¦æˆªå™¨ - æ·»åŠ è®¤è¯token
    _dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) async {
        final prefs = await SharedPreferences.getInstance();
        final token = prefs.getString('jwt_token');
        if (token != null) {
          options.headers['Authorization'] = 'Bearer $token';
        }
        handler.next(options);
      },
      onError: (error, handler) async {
        if (error.response?.statusCode == 401) {
          // Tokenè¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨
          final prefs = await SharedPreferences.getInstance();
          await prefs.remove('jwt_token');
          await prefs.remove('user_data');
        }
        handler.next(error);
      },
    ));
  }

  Dio get dio => _dio;
}
```

#### è®¤è¯æœåŠ¡
```dart
class AuthService {
  final HttpClient _httpClient = HttpClient();

  // é‚€è¯·ç æ³¨å†Œ
  Future<Map<String, dynamic>> inviteRegister({
    required String username,
    required String email,
    required String password,
    required String inviteCode,
  }) async {
    try {
      _httpClient.init();
      final response = await _httpClient.dio.post('/api/auth/invite-register', data: {
        'username': username,
        'email': email,
        'password': password,
        'inviteCode': inviteCode,
      });

      if (response.statusCode == 200) {
        return {'success': true, 'data': response.data};
      }
      return {'success': false, 'message': 'æ³¨å†Œå¤±è´¥'};
    } on DioException catch (e) {
      return {
        'success': false, 
        'message': e.response?.data?['error']?['message'] ?? 'ç½‘ç»œé”™è¯¯'
      };
    }
  }

  // ç”¨æˆ·ç™»å½•
  Future<Map<String, dynamic>> login({
    required String identifier,
    required String password,
  }) async {
    try {
      _httpClient.init();
      final response = await _httpClient.dio.post('/api/auth/local', data: {
        'identifier': identifier,
        'password': password,
      });

      if (response.statusCode == 200) {
        final data = response.data;
        await _saveAuthData(data['jwt'], data['user']);
        return {'success': true, 'data': data};
      }
      return {'success': false, 'message': 'ç™»å½•å¤±è´¥'};
    } on DioException catch (e) {
      return {
        'success': false, 
        'message': e.response?.data?['error']?['message'] ?? 'ç½‘ç»œé”™è¯¯'
      };
    }
  }

  // ä¿å­˜è®¤è¯ä¿¡æ¯
  Future<void> _saveAuthData(String token, Map<String, dynamic> userData) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('jwt_token', token);
    await prefs.setString('user_data', jsonEncode(userData));
  }
}
```

#### æ³¨å†Œé¡µé¢ç¤ºä¾‹
```dart
class RegisterPage extends StatefulWidget {
  @override
  _RegisterPageState createState() => _RegisterPageState();
}

class _RegisterPageState extends State<RegisterPage> {
  final _formKey = GlobalKey<FormState>();
  final _usernameController = TextEditingController();
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  final _inviteCodeController = TextEditingController();
  final _authService = AuthService();
  
  bool _isLoading = false;

  Future<void> _register() async {
    if (!_formKey.currentState!.validate()) return;
    
    setState(() => _isLoading = true);

    try {
      final result = await _authService.inviteRegister(
        username: _usernameController.text.trim(),
        email: _emailController.text.trim(),
        password: _passwordController.text,
        inviteCode: _inviteCodeController.text.trim(),
      );

      if (result['success']) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('æ³¨å†ŒæˆåŠŸï¼')),
        );
        Navigator.pushReplacementNamed(context, '/login');
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(result['message'] ?? 'æ³¨å†Œå¤±è´¥'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('æ³¨å†Œå¤±è´¥: $e'),
          backgroundColor: Colors.red,
        ),
      );
    } finally {
      setState(() => _isLoading = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('æ³¨å†Œ')),
      body: Form(
        key: _formKey,
        child: Padding(
          padding: EdgeInsets.all(16.0),
          child: Column(
            children: [
              TextFormField(
                controller: _usernameController,
                decoration: InputDecoration(labelText: 'ç”¨æˆ·å'),
                validator: (value) {
                  if (value == null || value.length < 3) {
                    return 'ç”¨æˆ·åè‡³å°‘3ä¸ªå­—ç¬¦';
                  }
                  return null;
                },
              ),
              TextFormField(
                controller: _emailController,
                decoration: InputDecoration(labelText: 'é‚®ç®±'),
                validator: (value) {
                  if (value == null || !value.contains('@')) {
                    return 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
                  }
                  return null;
                },
              ),
              TextFormField(
                controller: _passwordController,
                decoration: InputDecoration(labelText: 'å¯†ç '),
                obscureText: true,
                validator: (value) {
                  if (value == null || value.length < 6) {
                    return 'å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦';
                  }
                  return null;
                },
              ),
              TextFormField(
                controller: _inviteCodeController,
                decoration: InputDecoration(labelText: 'é‚€è¯·ç '),
                validator: (value) {
                  if (value == null || value.isEmpty) {
                    return 'è¯·è¾“å…¥é‚€è¯·ç ';
                  }
                  return null;
                },
              ),
              SizedBox(height: 20),
              ElevatedButton(
                onPressed: _isLoading ? null : _register,
                child: _isLoading 
                  ? CircularProgressIndicator() 
                  : Text('æ³¨å†Œ'),
              ),
            ],
          ),
        ),
      ),
    );
  }
}
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æ³¨å†Œæµ‹è¯•ç”¨ä¾‹

#### 1. æ­£å¸¸æ³¨å†Œæµç¨‹
```bash
curl -X POST http://118.107.4.158:1337/api/auth/invite-register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser001",
    "email": "test001@example.com",
    "password": "123456",
    "inviteCode": "AN2CN12D"
  }'
```

#### 2. éªŒè¯é”™è¯¯å¤„ç†
```bash
# ç”¨æˆ·åå¤ªçŸ­
curl -X POST http://118.107.4.158:1337/api/auth/invite-register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "ab",
    "email": "test@example.com",
    "password": "123456",
    "inviteCode": "AN2CN12D"
  }'

# æ— æ•ˆé‚®ç®±
curl -X POST http://118.107.4.158:1337/api/auth/invite-register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "invalid-email",
    "password": "123456",
    "inviteCode": "AN2CN12D"
  }'

# æ— æ•ˆé‚€è¯·ç 
curl -X POST http://118.107.4.158:1337/api/auth/invite-register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "123456",
    "inviteCode": "INVALID"
  }'
```

### ç™»å½•æµ‹è¯•ç”¨ä¾‹

#### 1. æ­£å¸¸ç™»å½•
```bash
curl -X POST http://118.107.4.158:1337/api/auth/local \
  -H "Content-Type: application/json" \
  -d '{
    "identifier": "testuser001",
    "password": "123456"
  }'
```

#### 2. é”™è¯¯ç™»å½•
```bash
# é”™è¯¯å¯†ç 
curl -X POST http://118.107.4.158:1337/api/auth/local \
  -H "Content-Type: application/json" \
  -d '{
    "identifier": "testuser001",
    "password": "wrongpassword"
  }'
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
```bash
# æ•°æ®åº“é…ç½®
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=strapi_db
DATABASE_USERNAME=postgres
DATABASE_PASSWORD=your_password

# JWT é…ç½®
JWT_SECRET=your_jwt_secret_key
ADMIN_JWT_SECRET=your_admin_jwt_secret

# æœåŠ¡å™¨é…ç½®
HOST=0.0.0.0
PORT=1337
NODE_ENV=production
```

### æ•°æ®åº“è¡¨ç»“æ„
- `up_users`: ç”¨æˆ·è¡¨
- `up_roles`: è§’è‰²è¡¨
- `qianbao_yues`: é’±åŒ…ä½™é¢è¡¨
- `qianbao_tixians`: æç°è®°å½•è¡¨
- `qianbao_chongzhis`: å……å€¼è®°å½•è¡¨

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥çœ‹ä»¥ä¸‹èµ„æºï¼š

1. **API æ–‡æ¡£**: `/api/documentation`
2. **æµ‹è¯•è„šæœ¬**: `test-registration.js`
3. **é”™è¯¯æ—¥å¿—**: æœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶
4. **æ•°æ®åº“**: ç›´æ¥æŸ¥è¯¢ç”¨æˆ·è¡¨éªŒè¯æ•°æ®

---

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-01)
- âœ… å®ç°é‚€è¯·ç æ³¨å†Œç³»ç»Ÿ
- âœ… é›†æˆ Strapi ç”¨æˆ·è®¤è¯
- âœ… è‡ªåŠ¨é’±åŒ…åˆ›å»º
- âœ… ç”¨æˆ·å…³ç³»ç®¡ç†
- âœ… è¾“å…¥éªŒè¯å’Œæ¸…ç†

---

*æ–‡æ¡£æœ€åæ›´æ–°: 2024å¹´1æœˆ1æ—¥* 