# è®¤è´­è®¡åˆ’400é”™è¯¯è¯Šæ–­æŠ¥å‘Š

## ğŸ” é—®é¢˜æè¿°
åœ¨Strapiåå°ç®¡ç†ç•Œé¢æ·»åŠ 5000Uæ¡£ä½çš„è®¤è´­è®¡åˆ’æ—¶å‡ºç°400é”™è¯¯ï¼š
```
[2025-07-24 05:43:48.727] error: APIé”™è¯¯:
[2025-07-24 05:43:48.727] http: POST /content-manager/collection-types/api::dinggou-jihua.dinggou-jihua? (54 ms) 400
```

## ğŸ“‹ ä»£ç åˆ†æç»“æœ

### 1. Schemaå®šä¹‰æ£€æŸ¥
**æ–‡ä»¶**: `src/api/dinggou-jihua/content-types/dinggou-jihua/schema.ts`

```typescript
const JihuaSchema = {
  attributes: {
    jihuaCode   : { type: 'string',  required: true, unique: true },   // PLAN500 â€¦
    benjinUSDT  : { type: 'string', required: true, default: '0' },    // 500 / 1000 â€¦
    zhouQiTian  : { type: 'integer', required: true, default: 15 },    // 15 / 20 â€¦
    jingtaiBili : { type: 'string', required: true, default: '0' },    // 6 / 7 â€¦
    aiBili      : { type: 'string', required: true, default: '0' },    // 3 / 4 â€¦
    choujiangCi : { type: 'integer',  default: 3 },
    kaiqi       : { type: 'boolean',  default: true },
    dingdanList : { type: 'relation', relation: 'oneToMany',
                    target: 'api::dinggou-dingdan.dinggou-dingdan', mappedBy: 'jihua' },
  },
};
```

### 2. æ§åˆ¶å™¨æ£€æŸ¥
**æ–‡ä»¶**: `src/api/dinggou-jihua/controllers/dinggou-jihua.ts`
- âœ… ä½¿ç”¨é»˜è®¤çš„CRUDæ§åˆ¶å™¨ï¼Œæ— è‡ªå®šä¹‰é€»è¾‘
- âœ… æ— è‡ªå®šä¹‰éªŒè¯è§„åˆ™

### 3. ç”Ÿå‘½å‘¨æœŸé’©å­æ£€æŸ¥
- âœ… è®¤è´­è®¡åˆ’æ¨¡å—æ— è‡ªå®šä¹‰ç”Ÿå‘½å‘¨æœŸé’©å­
- âœ… æ— beforeCreate/afterCreateç­‰é’©å­å½±å“

### 4. ä¸­é—´ä»¶æ£€æŸ¥
**æ–‡ä»¶**: `config/middlewares.ts`
```typescript
export default [
  'strapi::logger',
  'strapi::errors',
  'strapi::security',
  'strapi::cors',
  'strapi::poweredBy',
  'strapi::query',
  'strapi::body',
  'strapi::session',
  'strapi::favicon',
  'strapi::public',
  {
    name: 'global::error-handler',
    config: {},
  },
  {
    name: 'global::disablePreview',
    config: {},
  },
];
```

### 5. é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ£€æŸ¥
**æ–‡ä»¶**: `src/middlewares/error-handler.ts`
- âœ… åŒ…å«ValidationErrorå¤„ç†é€»è¾‘
- âœ… è¿”å›400çŠ¶æ€ç å’Œè¯¦ç»†é”™è¯¯ä¿¡æ¯

## ğŸš¨ å¯èƒ½çš„åŸå› åˆ†æ

### 1. æ•°æ®éªŒè¯å¤±è´¥ (æœ€å¯èƒ½)
**åŸå› **: æäº¤çš„æ•°æ®ä¸ç¬¦åˆSchemaå®šä¹‰çš„éªŒè¯è§„åˆ™

**å¯èƒ½çš„é—®é¢˜**:
- `jihuaCode` é‡å¤ (unique: true)
- å¿…å¡«å­—æ®µç¼ºå¤±
- æ•°æ®ç±»å‹ä¸åŒ¹é… (å¦‚string vs integer)
- å­—æ®µå€¼è¶…å‡ºèŒƒå›´æˆ–æ ¼å¼ä¸æ­£ç¡®

### 2. æ•°æ®åº“çº¦æŸå†²çª
**åŸå› **: æ•°æ®åº“çº§åˆ«çš„çº¦æŸæ£€æŸ¥å¤±è´¥

**å¯èƒ½çš„é—®é¢˜**:
- å”¯ä¸€ç´¢å¼•å†²çª
- å¤–é”®çº¦æŸé—®é¢˜
- æ•°æ®åº“å­—æ®µé•¿åº¦é™åˆ¶

### 3. æƒé™é—®é¢˜
**åŸå› **: ç®¡ç†å‘˜æƒé™ä¸è¶³æˆ–è®¤è¯é—®é¢˜

**å¯èƒ½çš„é—®é¢˜**:
- JWT Tokenè¿‡æœŸ
- æƒé™é…ç½®é”™è¯¯
- è§’è‰²æƒé™ä¸è¶³

### 4. å…¨å±€éªŒè¯è§„åˆ™
**åŸå› **: å…¨å±€ä¸­é—´ä»¶æˆ–éªŒè¯è§„åˆ™æ‹¦æˆª

**å¯èƒ½çš„é—®é¢˜**:
- å®‰å…¨ä¸­é—´ä»¶æ‹¦æˆª
- å…¨å±€éªŒè¯è§„åˆ™
- è¯·æ±‚æ ¼å¼é—®é¢˜

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ£€æŸ¥æ•°æ®æ ¼å¼ (æ¨è)
1. **éªŒè¯å¿…å¡«å­—æ®µ**:
   ```json
   {
     "jihuaCode": "PLAN5000",
     "benjinUSDT": "5000",
     "zhouQiTian": 15,
     "jingtaiBili": "6",
     "aiBili": "3",
     "choujiangCi": 3,
     "kaiqi": true
   }
   ```

2. **æ£€æŸ¥æ•°æ®ç±»å‹**:
   - `zhouQiTian`: å¿…é¡»æ˜¯integerï¼Œä¸æ˜¯string
   - `choujiangCi`: å¿…é¡»æ˜¯integerï¼Œä¸æ˜¯string
   - `kaiqi`: å¿…é¡»æ˜¯booleanï¼Œä¸æ˜¯string
   - å…¶ä»–å­—æ®µ: å¿…é¡»æ˜¯string

### æ–¹æ¡ˆ2: æ£€æŸ¥å”¯ä¸€æ€§çº¦æŸ
1. **æŸ¥è¯¢ç°æœ‰è®¡åˆ’**:
   ```bash
   curl -X GET "http://118.107.4.158:1337/api/dinggou-jihuas"
   ```

2. **ç¡®ä¿jihuaCodeå”¯ä¸€**:
   - æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„jihuaCode
   - ä½¿ç”¨æ–°çš„å”¯ä¸€ä»£ç 

### æ–¹æ¡ˆ3: å¯ç”¨è¯¦ç»†é”™è¯¯æ—¥å¿—
1. **ä¿®æ”¹é”™è¯¯å¤„ç†ä¸­é—´ä»¶**ï¼Œæ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—
2. **æ£€æŸ¥Strapiæ—¥å¿—æ–‡ä»¶**è·å–å…·ä½“é”™è¯¯ä¿¡æ¯

### æ–¹æ¡ˆ4: æ•°æ®åº“æ£€æŸ¥
1. **æ£€æŸ¥æ•°æ®åº“è¿æ¥**
2. **éªŒè¯è¡¨ç»“æ„**
3. **æ£€æŸ¥çº¦æŸå’Œç´¢å¼•**

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. ä½¿ç”¨æµ‹è¯•è„šæœ¬
è¿è¡Œåˆ›å»ºçš„æµ‹è¯•è„šæœ¬ `test-dinggou-jihua.js`:
```bash
node test-dinggou-jihua.js
```

### 2. æ‰‹åŠ¨æµ‹è¯•
ä½¿ç”¨curlå‘½ä»¤æµ‹è¯•:
```bash
curl -X POST "http://118.107.4.158:1337/content-manager/collection-types/api::dinggou-jihua.dinggou-jihua" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "jihuaCode": "PLAN5000_TEST",
    "benjinUSDT": "5000",
    "zhouQiTian": 15,
    "jingtaiBili": "6",
    "aiBili": "3",
    "choujiangCi": 3,
    "kaiqi": true
  }'
```

### 3. æ£€æŸ¥ç°æœ‰æ•°æ®
```bash
curl -X GET "http://118.107.4.158:1337/api/dinggou-jihuas"
```

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ£€æŸ¥**: åœ¨åå°ç•Œé¢æŸ¥çœ‹å…·ä½“çš„é”™è¯¯æ¶ˆæ¯
2. **æ•°æ®éªŒè¯**: ç¡®ä¿æ‰€æœ‰å­—æ®µæ ¼å¼æ­£ç¡®
3. **å”¯ä¸€æ€§æ£€æŸ¥**: ç¡®ä¿jihuaCodeä¸é‡å¤
4. **æ—¥å¿—åˆ†æ**: æŸ¥çœ‹Strapiè¯¦ç»†æ—¥å¿—
5. **æµ‹è¯•éªŒè¯**: ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤

## ğŸ” è°ƒè¯•æŠ€å·§

1. **æµè§ˆå™¨å¼€å‘è€…å·¥å…·**: æŸ¥çœ‹ç½‘ç»œè¯·æ±‚çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. **Strapiæ—¥å¿—**: æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—è·å–å…·ä½“é”™è¯¯
3. **æ•°æ®åº“æŸ¥è¯¢**: ç›´æ¥æŸ¥è¯¢æ•°æ®åº“éªŒè¯æ•°æ®
4. **é€æ­¥æµ‹è¯•**: é€ä¸ªå­—æ®µæµ‹è¯•ï¼Œæ‰¾å‡ºé—®é¢˜å­—æ®µ

---
*è¯Šæ–­æ—¶é—´: 2024å¹´1æœˆ1æ—¥*
*è¯Šæ–­äººå‘˜: AI Assistant* 